"use strict";let container,statusElement,canvas,graphics,sourceInfo,host,stream,audio,gain,analyser,freqData,timeData,animationFrameId;function fetchStatus(e){return window.fetch(`${e}/status-json.xsl`).then(e=>e.json().then(e=>e.icestats))}function onAnimationFrame(e){animationFrameId=window.requestAnimationFrame(onAnimationFrame),analyser.getByteTimeDomainData(timeData),analyser.getByteFrequencyData(freqData),graphics.fillStyle=theme.background,graphics.fillRect(0,0,canvas.width,canvas.height),graphics.fillStyle=theme.f_med,graphics.lineWidth=1,drawTimedata(0,0,canvas.width,canvas.height),updateStatusText(e)}function drawTimedata(e,t,n,s){graphics.beginPath(),graphics.strokeStyle=theme.f_med;const a=n*1/analyser.frequencyBinCount,r=s/2;let o=0,i=0;for(let n=0;n<analyser.frequencyBinCount;n++)i=timeData[n]/128*r,n==0?graphics.moveTo(e+o,t+i):graphics.lineTo(e+o,t+i),o+=a;graphics.stroke()}function drawFrequencies(e,t,n,s){graphics.fillStyle=theme.f_med;const i=analyser.frequencyBinCount;let o=Math.floor(n/i);o<=0&&(o=1);let a,r=0;for(let n=0;n<i;n++)a=freqData[n]*2,graphics.fillRect(e+r,s-a-t,o,1),r+=o}function updateStatusText(e,t){let n="";sourceInfo&&(n+=sourceInfo.artist+" "+sourceInfo.title+" ["+sourceInfo.listeners+"]["+sourceInfo.audio_channels+"ch/"+sourceInfo.audio_samplerate+"hz/"+sourceInfo["ice-bitrate"]+"]"),e&&(n+=" <br>"+e),t&&(n+=" "+t),statusElement.innerHTML=n}function playStream(e){audio=document.createElement("audio"),audio.preload="none",audio.crossOrigin="anonymous",audio.controls=!1,audio.onplaying=e=>{const t=new AudioContext;gain=t.createGain(),gain.connect(t.destination),analyser=t.createAnalyser(),analyser.fftSize=1024,analyser.connect(gain),freqData=new Uint8Array(analyser.frequencyBinCount),timeData=new Uint8Array(analyser.frequencyBinCount);const n=t.createMediaElementSource(audio);n.connect(analyser),animationFrameId=window.requestAnimationFrame(onAnimationFrame)};const t=document.createElement("source");t.type=e.server_type,t.src=host+"/"+e.server_name,audio.append(t),audio.play()}function stopStream(){audio&&(audio.pause(),audio.onpause=e=>{audio=null},graphics.clearRect(0,0,canvas.width,canvas.height),animationFrameId&&(window.cancelAnimationFrame(animationFrameId),animationFrameId=null))}function fitCanvas(){if(canvas){const t=canvas.parentElement,e=t.getBoundingClientRect(),n=Math.round(e.width-e.x),s=Math.round(e.height-e.y);canvas.width=n,canvas.height=s}}window.addEventListener("load",e=>{if(container=document.body.querySelector("div.livestream"),!container)return;host=container.getAttribute("data-host"),stream=container.getAttribute("data-stream"),statusElement=container.querySelector(".status"),canvas=container.querySelector("canvas.spectrum"),graphics=canvas.getContext("2d"),fitCanvas(),window.onresize=e=>{fitCanvas()},fetchStatus(host).then(e=>{let t;if(Array.isArray(e.source)){for(let n=0;n<e.source.length;n++){const s=e.source[n];if(s.server_name===stream){t=s;break}}}else e.source.server_name===stream&&(t=e.source);t?(sourceInfo=t,updateStatusText(null,"<br>CLICK TO PLAY"),container.onclick=e=>{audio?stopStream():t&&playStream(t)}):console.warn("No livestream source found")})},!1)